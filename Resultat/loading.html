<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="loading.css">
    <script src="chart.umd.js"></script> 
    <script src="graphique.js"></script>    
    <title>Calcul des r√©sultats...</title>
    <style>
       
    </style>
</head>
<body>

    <h2 id="welcomeMessage">
        Bienvenue <span id="userPseudo"></span> !
    </h2>
      
    <p id="loadingText">Calcul de vos r√©sultats...</p>
    <div id="loadingBarContainer">
        <div id="loadingBar"></div>
    </div>

    <div id="resultContainer">
        <p>üèÜ Votre score actuelle : <span id="userScore"></span> points</p>
    
        <div id="progressBarContainer">
            <div id="progressBar"></div>
            <span id="arrow">&#8594;</span>
        </div>
    
        <div id="level">
            <p id="levelText">D√©butant</p>
        </div>
    
        <div id="timeSpent">
            ‚è±Ô∏è Temps pass√© sur l‚Äôappli : <span id="userTime">0</span> 
        </div>
        <br> 

        <div id="userResults"></div>
    </div>


   

    <div id="ContainerBis">
       

    </div>
    



    <button id="backButton" class="btn-retour" onclick="window.location.href='../site.html'">
        Retour √† l‚Äôaccueil
    </button>


    


    <script>
        let progress = 0;
        let loadingBar = document.getElementById("loadingBar");

        let interval = setInterval(() => {
            progress += 15;
            loadingBar.style.width = progress + "%";

            if (progress >= 100) {
                clearInterval(interval);
                setTimeout(() => {
                    document.getElementById("loadingBarContainer").style.display = "none";                 
                    document.getElementById("loadingText").style.display = "none";

                    // Masquer le message de bienvenue
                    document.getElementById("welcomeMessage").style.display = "none";

                    document.getElementById("resultContainer").style.display = "block";
                    document.getElementById("ContainerBis").style.display = "block";



                    document.getElementById("userResults").style.display = "block";

                    document.getElementById("backButton").style.display = "inline-block";

                }, 500);
            }
        }, 500);

        document.addEventListener("DOMContentLoaded", function () {
            let pseudo = localStorage.getItem("pseudo") || "Utilisateur inconnu";
            document.getElementById("userPseudo").innerText = pseudo;
        });

        function initUserTime(pseudo) {
            const key = `time_${pseudo}`;
            if (!localStorage.getItem(key)) {
                localStorage.setItem(key, "0");
            }
        }

        // R√©cup√®re le temps total (en secondes) pour un pseudo
        function getUserTime(pseudo) {
        return parseInt(localStorage.getItem(`time_${pseudo}`)) || 0;
        }

        function formatTime(seconds) {
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = seconds % 60;
            const parts = [];
            if (h) parts.push(`${h} h`);
            if (m) parts.push(`${m} min`);
            parts.push(`${s} s`);
            return parts.join(' ');
        }


      
        document.addEventListener("DOMContentLoaded", function () {
            // R√©cup√©rer le pseudo de l'utilisateur
            let pseudo = localStorage.getItem("pseudo") || "Utilisateur inconnu";
            
            // R√©cup√©rer le score de l'utilisateur √† partir de sa cl√© sp√©cifique
            let score = localStorage.getItem(`score_${pseudo}`) || "0";  // Utiliser le pseudo pour la cl√©

            // R√©cup√©rer et afficher le temps total (en secondes)
            const totalTime = getUserTime(pseudo);
            document.getElementById("userTime").innerText = formatTime(totalTime);
            
            // Afficher le pseudo et le score
            document.getElementById("userPseudo").innerText = pseudo;
            document.getElementById("userScore").innerText = score;
        });    
        
        document.addEventListener("DOMContentLoaded", function () {
            // R√©cup√©rer le pseudo de l'utilisateur
            let pseudo = localStorage.getItem("pseudo") || "Utilisateur inconnu";
            
            // R√©cup√©rer le score de l'utilisateur √† partir de sa cl√© sp√©cifique
            let score = localStorage.getItem(`score_${pseudo}`) || 0;  // Utiliser le pseudo pour la cl√©
            
            // Fonction pour mettre √† jour la barre de progression et le niveau
            function updateProgressBar(score) {
                // Calculer la largeur de la barre de progression (de 0 √† 100)
                //let progress = (score / 100) * 100;
                
                // Ajuster la largeur de la barre de progression
                
                
                // Calculer la position de la fl√®che et de la barre de progression
                let progress = 0;
                let level = "";
                if (score < 30) {
                    progress = (score / 30) * 100; // Remplir la barre pour le niveau D√©butant
                    level = "D√©butant";
                } else if (score < 60) {
                    progress = ((score - 30) / 30) * 100; // Remplir la barre pour le niveau Amateur
                    level = "Amateur";
                } else if (score < 120) {
                    progress = ((score - 60) / 60) * 100; // Remplir la barre pour le niveau Pro
                    level = "Pro";
                } else if (score <= 200) {
                    progress = ((score - 120) / 120) * 100; // Remplir la barre pour le niveau L√©gende
                    level = "L√©gende";
                } else {
                    // Cas o√π le score d√©passe 100
                    progress = 100;
                    level = "Elite";
}
                document.getElementById("progressBar").style.width = progress + "%";
                
                // Ajuster la position de la fl√®che
                document.getElementById("arrow").style.left = progress + "%";
                
                // Afficher le niveau
                document.getElementById("levelText").innerText = level;
            }

            // Mettre √† jour la barre de progression et le niveau en fonction du score de l'utilisateur
            updateProgressBar(score);
        });

        

        
    </script>

<script>

    function analyserResolution(vraie, choisie,screenType) {
        const niveaux = ["144p", "240p", "360p", "480p", "720p", "1080p", "4k"];
        const iVraie = niveaux.indexOf(vraie);
        const iChoisie = niveaux.indexOf(choisie);
        if (iVraie === -1 || iChoisie === -1) return "‚ö†Ô∏è R√©solution inconnue.";

        if (iVraie === iChoisie) return "<span class='bonne-reponse'>‚úÖ Bonne estimation de la r√©solution.</span>";
        
        if (vraie === "144p" && (choisie === "240p" || choisie === "360p")) {
            if (screenType === "mobile" || screenType === "tablet" || screenType === "pc") {
                return `<span class='mauvaise-reponse'>üìâ 144p semble plus net sur un petit √©cran ${screenType}, mais reste tr√®s basse qualit√©.</span>`;
        } else {
            return `<span class='mauvaise-reponse'>üìâ 144p reste tr√®s flou ‚Äî facile √† confondre avec d'autres basses r√©solutions.</span>`;
        }       
                }
        if (vraie === "240p" && (choisie === "360p" || choisie === "480p")) {
            if (screenType === "mobile" || screenType === "tablet" || screenType === "pc") {
                return `<span class='mauvaise-reponse'>üìâ 240p reste tr√®s flou ‚Äî l'√©cran ${screenType} peut donner une illusion de nettet√©.</span>`;
            }
        }
        if (vraie === "480p" && (choisie === "720p" || choisie === "1080p")) {
            let message = "üì∫ Vous avez per√ßu une qualit√© HD alors que ce n'√©tait que du 480p.";
            
            if (screenType === "mobile" || screenType === "tablet") {
                message += ` Sur un petit √©cran (${screenType}), les d√©tails manquants peuvent √™tre moins visibles.`;
            } else if (screenType === "pc") {
                message += " Sur un √©cran d‚Äôordinateur, la diff√©rence aurait d√ª √™tre plus marqu√©e.";
            } else if (screenType === "tv") {
                message += " Sur une TV, le manque de nettet√© est g√©n√©ralement plus √©vident.";
            }

            return `<span class='mauvaise-reponse'>${message}</span>`;
        }
        if (vraie === "720p" && (choisie === "1080p" || choisie === "4k")) {
            if (screenType === "mobile" || screenType === "tablet") {
                return `<span class='mauvaise-reponse'>üé• Vous avez vu du HD comme du Full HD ou 4K.<br>Sur un ${screenType}, les hautes r√©solutions paraissent souvent plus proches visuellement.</span>`;
            } else if (screenType === "tv") {
                return `<span class='mauvaise-reponse'>üé• Vous avez vu du HD comme du Full HD ou 4K.<br>Sur un grand √©cran comme une TV, les √©carts de qualit√© deviennent plus visibles, mais le 720p peut encore sembler net.</span>`;
            } else {
                return `<span class='mauvaise-reponse'>üé• Vous avez confondu du 720p avec une r√©solution sup√©rieure.<br>Sur un √©cran ${screenType}, cela peut arriver si l'image est bien compress√©e ou bien √©clair√©e.</span>`;
            }
        }

        const diff = iChoisie - iVraie;
        if (diff >= 2) {
            if (screenType === "mobile" || screenType === "tablet") {
                return `<span class='mauvaise-reponse'>üîç Vous avez nettement surestim√© la qualit√©.<br>Sur un ${screenType}, les faibles r√©solutions peuvent para√Ætre plus nettes, induisant une surestimation.</span>`;
            } else if (screenType === "tv") {
                return `<span class='mauvaise-reponse'>üîç Vous avez surestim√© la qualit√©.<br>Sur une TV, les √©carts de r√©solution sont plus visibles ‚Äî ici, c'√©tait trompeur.</span>`;
            } else {
                return `<span class='mauvaise-reponse'>üîç Vous avez nettement surestim√© la qualit√©.<br>Certains √©crans comme le v√¥tre (${screenType}) peuvent lisser les d√©fauts d'image, donnant une impression de meilleure qualit√©.</span>`;
            }
        }

        if (diff <= -2) {
            if (screenType === "mobile" || screenType === "tablet") {
                return `<span class='mauvaise-reponse'>üëÅÔ∏è Vous avez sous-estim√© la qualit√©.<br>Sur un petit √©cran (${screenType}), m√™me les vid√©os de bonne qualit√© peuvent sembler ordinaires.</span>`;
            } else if (screenType === "tv") {
                return `<span class='mauvaise-reponse'>üëÅÔ∏è Vous avez sous-estim√© la qualit√©.<br>Sur une TV, une bonne r√©solution peut sembler moins impressionnante si la source est mal optimis√©e.</span>`;
            } else {
                return `<span class='mauvaise-reponse'>üëÅÔ∏è Vous avez sous-estim√© la qualit√©.<br>Des facteurs comme l‚Äô√©clairage ou le type d'√©cran (${screenType}) peuvent r√©duire la perception de nettet√©.</span>`;
            }
        }

        return "<span class='mauvaise-reponse'>‚ÑπÔ∏è Estimation approximative, mais pas trop √©loign√©e.</span>";
    }

    function analyserConfortVisionnage(resolution, confort) {
        const niveaux = ["144p", "240p", "360p", "480p", "720p", "1080p", "4k"];
        const faibles = niveaux.slice(0, 4);  // 144p ‚Üí 480p
        const hautes = niveaux.slice(4);      // 720p ‚Üí 4k

        // Nettoyer et normaliser la r√©solution
        let resClean = resolution.toString().toLowerCase().replace(/\s+/g, '');
        
        // Normalisation sp√©ciale : transformer "2160p" en "4k"
        if (resClean === "2160p") resClean = "4k";
        if (!resClean.endsWith("p") && resClean !== "4k") resClean += "p";

        const confortClean = (confort || "").trim().toLowerCase();

        const isFaible = faibles.includes(resClean);
        const isHaute = hautes.includes(resClean);

        if (!niveaux.includes(resClean)) {
            return "‚ö†Ô∏è R√©solution inconnue, analyse impossible.";
        }

        // Analyse du confort selon le type de r√©solution
        if (isFaible) {
            if (confortClean === "verysatisfactory" || confortClean === "correct") {
                return "<span class='reponse_ImgQal1'>üëç Malgr√© la basse r√©solution, vous avez trouv√© le confort visuel satisfaisant ‚Äî cela montre que d'autres facteurs ont su compenser la qualit√© de l'image.</span>";
            } else if (["notsatisfactory", "bad", "unwatchable"].includes(confortClean)) {
                return "<span class='reponse_ImgQal2'>üìâ Votre inconfort est compr√©hensible au vu de la faible r√©solution de la vid√©o.</span>";
            }
        }

        if (isHaute) {
            if (confortClean === "verysatisfactory" || confortClean === "correct") {
                return "<span class='reponse_ImgQal1'>‚úÖ Une bonne qualit√© d‚Äôimage semble avoir contribu√© √† un visionnage agr√©able.</span>";
            } else if (["notsatisfactory", "bad", "unwatchable"].includes(confortClean)) {
                return "<span class='reponse_ImgQal2'>‚ùó Malgr√© une r√©solution √©lev√©e, vous avez ressenti de l‚Äôinconfort ‚Äî cela peut √™tre d√ª √† des probl√®mes de compression, de fluidit√© ou √† des attentes plus √©lev√©es.</span>";
            }
        }

        //return "‚ÑπÔ∏è Votre avis sur le confort de visionnage r√©v√®le une perception nuanc√©e, au-del√† de la seule r√©solution.";

        // Ajout d‚Äôun compl√©ment par type d‚Äôappareil
        let deviceMessage = "";
        switch (screenType) {
            case "mobile":
                deviceMessage = "<span class='deviceInfo'>üì± Visionnage sur mobile : la taille de l‚Äô√©cran peut att√©nuer l‚Äôimpact d‚Äôune faible r√©solution, mais accentuer l‚Äôinconfort sur certaines sc√®nes.</span>";
                break;
            case "tablet":
                deviceMessage = "<span class='deviceInfo'>üì±üìò Sur tablette, l‚Äô√©quilibre entre confort et r√©solution est souvent meilleur, mais reste sensible √† la qualit√© du r√©seau.</span>";
                break;
            case "pc":
                deviceMessage = "<span class='deviceInfo'>üñ•Ô∏è Visionnage sur PC : les hautes r√©solutions sont plus visibles, mais aussi plus exigeantes en termes de compression et de fluidit√©.</span>";
                break;
            default:
                deviceMessage = "<span class='deviceInfo'>üßê Type d'appareil non d√©tect√©. Analyse limit√©e.</span>";
        }

        return message + "<br>" + deviceMessage;
    }







    document.addEventListener("DOMContentLoaded", function () {
    // R√©cup√©rer les sessions depuis le localStorage
    let storedData = sessionStorage.getItem("feedbackSessions");

    let resultHTML = `<h3 class="section-title">üß† Vos r√©ponses et les vraies r√©solutions</h3>`;

    if (storedData) {
        let sessions = JSON.parse(storedData);
        console.log(storedData);
        console.log("üìã Toutes les sessions de cette visite :", sessions);


        sessions.forEach((data, sessionIndex) => {
            let videoNumber = sessionIndex + 1;

            // Extraire les donn√©es de r√©solution utilisateur
            let userResolution1 = data.QO1.replace(/[()]/g, "").split(",")[0].trim();
            let userResolution2 = data.QO1.replace(/[()]/g, "").split(",")[1].trim();

            let correctResolution1 = data.resolution1;
            let correctResolution2 = data.resolution2;

            let imageQuality1 = data.QO2.replace(/[()]/g, "").split(",")[0].trim(); 
            let imageQuality2 = data.QO2.replace(/[()]/g, "").split(",")[1].trim();

            let fluidity1 = data.QO4.replace(/[()]/g, "").split(",")[0].trim();
            let fluidity2 = data.QO4.replace(/[()]/g, "").split(",")[1].trim();

            let preferredVideo = data.QO3;
            let importantCriteria = data.QO5;
            let screenType = data.screenType;

            // Analyse des r√©ponses
            const analyse1 = analyserResolution(correctResolution1, userResolution1, screenType);
            const analyse2 = analyserResolution(correctResolution2, userResolution2, screenType);

            const confort1 = analyserConfortVisionnage(correctResolution1, imageQuality1);
            const confort2 = analyserConfortVisionnage(correctResolution2, imageQuality2);

            resultHTML += `
                <div class="video-result">
                    <p><strong>üé¨ Video ${videoNumber} R√©solution 1 :</strong></p>
                    <p>‚úÖ R√©solution correcte : <span class="bonne-reponse">${correctResolution1}</span></p>
                    <p>üìù Votre r√©ponse : 
                        <span class="${userResolution1 === correctResolution1 ? 'bonne-reponse' : 'mauvaise-reponse'}">${userResolution1}</span>
                    </p>
                    <p>${analyse1}</p>
                    <p>üéØ ${confort1}</p>
                </div>

                <div class="video-result">
                    <p><strong>üé¨Video ${videoNumber} R√©solution 2 :</strong></p>
                    <p>‚úÖ R√©solution correcte : <span class="bonne-reponse">${correctResolution2}</span></p>
                    <p>üìù Votre r√©ponse : 
                        <span class="${userResolution2 === correctResolution2 ? 'bonne-reponse' : 'mauvaise-reponse'}">${userResolution2}</span>
                    </p>
                    <p>${analyse2}</p>
                    <p>üéØ ${confort2}</p>
                </div>
            `;
        });

        let resultHTML_3 = `
               

                <div class="video-result">
                    

                    <h3 class="section-title">üìä Statistiques en graphiques</h3>
                    <canvas id="chartPrecision" width="600" height="400"></canvas>

                    <canvas id="chartConfusions" width="800" height="600"></canvas>

                    <canvas id="chartSatisfaction1" width="600" height="400"></canvas>
                    <canvas id="chartSatisfaction2" width="600" height="400"></canvas>


                    
                </div>
            `;

            let resultHTML_4 = `
               

               <div class="video-result">

                   
               </div>
           `;


        // Injecter le HTML final dans la page
        document.getElementById("userResults").innerHTML = resultHTML;
        document.getElementById("ContainerBis").innerHTML = resultHTML_3;

       


        const username = localStorage.getItem("pseudo");
        const baseURL = `http://${window.location.hostname}:3300`;


        fetch(`${baseURL}/precision/${encodeURIComponent(username)}`)
            .then(res => res.json())
            .then(({ precision, moyenne }) => {
                console.log("Pr√©cision utilisateur :", precision);
                console.log("Pr√©cision moyenne :", moyenne);
                afficherGraphiquePrecision(precision, moyenne);
            })
            .catch(err => console.error("Erreur pr√©cision cumul√©e :", err));


        fetch(`${baseURL}/confusions/${username}`) 
            .then(res => res.json())
            .then(data => {
                afficherGraphiqueConfusions(data);
            })
            .catch(err => console.error("Erreur r√©cup√©ration des confusions :", err));

        fetch(`${baseURL}/satisfaction/${username}`)
            .then(res => res.json())
            .then(data => {
                afficherSatisfactionParResolution(data.video1, 'Vid√©o 1', 'chartSatisfaction1');
                afficherSatisfactionParResolution(data.video2, 'Vid√©o 2', 'chartSatisfaction2');
            })
            .catch(err => console.error("Erreur chargement satisfaction :", err));

    }
});


    

</script>





</body>
</html>
